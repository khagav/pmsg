<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>访客消息页</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 min-h-screen flex flex-col">
  <header class="bg-white shadow-sm p-4 text-center">
    <h1 class="text-2xl font-bold text-blue-600">访客消息页</h1>
  </header>

  <!-- 初始输入界面 -->
  <div class="flex-1 flex flex-col justify-center items-center p-4">
    <div class="bg-white rounded-xl shadow-md p-6 w-full max-w-md">
      <div class="mb-4">
        <label class="block text-gray-700 mb-2">你的昵称</label>
        <input type="text" id="guestNickname" placeholder="输入昵称" 
          class="w-full px-4 py-2 border rounded-lg">
      </div>
      <button id="enterBtn" class="w-full py-3 bg-blue-600 text-white rounded-lg">
        进入聊天
      </button>
    </div>
  </div>

  <!-- 聊天界面 -->
  <div id="chatScreen" class="hidden flex-1 flex flex-col p-4">
    <!-- 验证状态提示 -->
    <div id="verifyTip" class="hidden p-2 bg-yellow-50 text-yellow-700 rounded-lg mb-2 text-sm">
      你的消息需等待主人验证通过...
    </div>

    <div class="bg-white rounded-xl shadow-sm p-4 h-full flex flex-col">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-bold">给i发消息</h3>
        <span id="status" class="text-xs px-2 py-1 rounded-full bg-gray-100">未连接</span>
      </div>
      <div id="messages" class="flex-1 overflow-y-auto mb-4 p-2"></div>
      <div class="flex">
        <input type="text" id="msgInput" placeholder="输入消息..." 
          class="flex-1 px-4 py-2 border rounded-l-lg">
        <button id="sendBtn" class="bg-blue-600 text-white px-4 py-2 rounded-r-lg">发送</button>
      </div>
    </div>
  </div>

  <script>
    // 替换为你的主人iId（从主人页面生成后填入）
    const iId = "i_1719283746509abc"; 

    // 替换为你的信令服务器地址（部署后填写）
    const SIGNAL_WS = 'wss://signal-worker.yourname.workers.dev'; 
    let ws, guestId, isVerified = false;

    // 生成/读取客人ID及验证状态（本地存储）
    const GUEST_STORAGE_KEY = 'guest_info';
    const storedGuest = localStorage.getItem(GUEST_STORAGE_KEY);
    if (storedGuest) {
      const data = JSON.parse(storedGuest);
      guestId = data.id;
      isVerified = data.isVerified || false;
    } else {
      guestId = 'guest_' + Date.now() + Math.random().toString(36).slice(2, 8);
    }

    // 进入聊天
    document.getElementById('enterBtn').addEventListener('click', () => {
      const nickname = document.getElementById('guestNickname').value.trim();
      if (!nickname) return alert('请输入昵称');
      
      localStorage.setItem(GUEST_STORAGE_KEY, JSON.stringify({
        nickname: nickname,
        id: guestId,
        isVerified: isVerified
      }));
      
      document.querySelector('.flex-1').classList.add('hidden');
      document.getElementById('chatScreen').classList.remove('hidden');
      connectToServer(nickname);
    });

    // 连接信令服务器
    function connectToServer(nickname) {
      ws = new WebSocket(`${SIGNAL_WS}?id=${guestId}&role=guest`);
      
      ws.onopen = () => {
        document.getElementById('status').textContent = '在线';
        document.getElementById('status').className = 'text-xs px-2 py-1 rounded-full bg-green-100 text-green-800';
      };

      // 接收消息
      ws.onmessage = (event) => {
        const data = JSON.parse(event.data);
        if (data.type === 'verifyPass') {
          // 验证通过
          isVerified = true;
          document.getElementById('verifyTip').classList.add('hidden');
          localStorage.setItem(GUEST_STORAGE_KEY, JSON.stringify({
            nickname: document.getElementById('guestNickname').value,
            id: guestId,
            isVerified: true
          }));
          alert('主人已通过你的验证，可正常发送消息！');
        } else if (data.type === 'verifyReject') {
          // 验证被拒绝
          document.getElementById('verifyTip').textContent = '你的消息已被主人拒绝';
          document.getElementById('verifyTip').className = 'p-2 bg-red-50 text-red-700 rounded-lg mb-2 text-sm';
        } else if (data.type === 'message' && data.from === 'i') {
          // 接收主人消息
          addMessage('i', data.content, data.time);
        }
      };

      ws.onclose = () => {
        document.getElementById('status').textContent = '离线';
        document.getElementById('status').className = 'text-xs px-2 py-1 rounded-full bg-gray-100 text-gray-800';
      };
    }

    // 发送消息
    document.getElementById('sendBtn').addEventListener('click', () => {
      const content = document.getElementById('msgInput').value.trim();
      if (!content) return;
      
      const nickname = document.getElementById('guestNickname').value;
      const messageData = {
        type: isVerified ? 'message' : 'verifyRequest', // 首次为验证请求
        to: iId,
        from: nickname,
        guestId: guestId,
        content: content,
        time: new Date().toLocaleTimeString()
      };
      
      ws.send(JSON.stringify(messageData));
      addMessage('我', content, messageData.time);
      document.getElementById('msgInput').value = '';
      
      // 首次发送显示验证提示
      if (!isVerified) {
        document.getElementById('verifyTip').classList.remove('hidden');
      }
    });

    // 添加消息到界面
    function addMessage(from, content, time) {
      const msgDiv = document.createElement('div');
      const isSelf = from === '我';
      msgDiv.className = `mb-2 p-2 rounded-lg ${isSelf ? 'bg-blue-50' : 'bg-gray-50'}`;
      msgDiv.innerHTML = `
        <div class="text-xs text-gray-500">${from} ${time}</div>
        <div>${content}</div>
      `;
      document.getElementById('messages').appendChild(msgDiv);
      document.getElementById('messages').scrollTop = document.getElementById('messages').scrollHeight;
    }
  </script>
</body>
</html>

