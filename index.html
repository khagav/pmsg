<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>消息系统</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <style>
    .panel { display: none; }
    .panel.active { display: flex; }
  </style>
</head>
<body class="bg-gray-50 min-h-screen">
  <!-- 客人默认界面（默认显示） -->
  <div id="guestPanel" class="panel active min-h-screen flex flex-col">
    <!-- 顶部导航（含主人管理入口） -->
    <header class="bg-white shadow-sm p-4">
      <div class="flex items-center justify-between">
        <h1 class="text-xl font-bold text-blue-600">消息发送</h1>
        <!-- 主人管理入口按钮 -->
        <button id="adminBtn" class="p-2 text-gray-600 hover:text-green-600 transition-colors">
          <<i class="fa fa-cog" aria-label="主人管理入口"></</i>
        </button>
      </div>
    </header>

    <!-- 客人登录界面（首次进入显示） -->
    <div id="guestLogin" class="flex-1 flex flex-col justify-center items-center p-4">
      <div class="bg-white rounded-xl shadow-md p-6 w-full max-w-md">
        <div class="mb-4">
          <label class="block text-gray-700 mb-2">你的昵称</label>
          <input type="text" id="guestNickname" placeholder="请输入昵称" 
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
        </div>
        <button id="guestEnterBtn" class="w-full py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
          进入聊天
        </button>
      </div>
    </div>

    <!-- 客人聊天界面（登录后显示） -->
    <div id="guestChat" class="hidden flex-1 flex flex-col p-4">
      <!-- 验证状态提示 -->
      <div id="guestVerifyTip" class="hidden p-2 bg-yellow-50 text-yellow-700 rounded-lg mb-2 text-sm">
        你的消息需等待主人验证通过...
      </div>

      <div class="bg-white rounded-xl shadow-sm p-4 h-full flex flex-col">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-lg font-bold">发送消息</h3>
          <span id="guestStatus" class="text-xs px-2 py-1 rounded-full bg-gray-100">未连接</span>
        </div>
        <div id="guestMessages" class="flex-1 overflow-y-auto mb-4 p-2"></div>
        <div class="flex">
          <input type="text" id="guestMsgInput" placeholder="输入消息..." 
            class="flex-1 px-4 py-2 border border-gray-300 rounded-l-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
          <button id="guestSendBtn" class="bg-blue-600 text-white px-4 py-2 rounded-r-lg hover:bg-blue-700 transition-colors">
            发送
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- 主人管理界面（通过管理按钮进入） -->
  <div id="hostPanel" class="panel hidden min-h-screen flex flex-col">
    <header class="bg-white shadow-sm p-4">
      <div class="flex items-center justify-between">
        <h1 class="text-xl font-bold text-green-600">主人管理中心</h1>
        <button id="hostBackBtn" class="text-gray-600 hover:text-green-600 transition-colors">
          ← 返回客人界面
        </button>
      </div>
    </header>

    <!-- 主人登录界面 -->
    <div id="hostLogin" class="flex-1 flex flex-col justify-center items-center p-4">
      <div class="bg-white rounded-xl shadow-md p-6 w-full max-w-md">
        <div class="mb-4">
          <label class="block text-gray-700 mb-2">主人ID</label>
          <input type="text" id="hostId" placeholder="输入主人ID" 
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
          <button id="hostGenIdBtn" class="mt-2 text-green-600 hover:underline text-sm">生成ID</button>
        </div>
        <div class="mb-4">
          <label class="block text-gray-700 mb-2">密码（至少6位）</label>
          <input type="password" id="hostPassword" placeholder="输入密码" 
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
        </div>
        <button id="hostLoginBtn" class="w-full py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
          登录管理
        </button>
      </div>
    </div>

    <!-- 主人管理界面（登录后显示） -->
    <div id="hostManage" class="hidden flex-1 flex flex-col p-4">
      <div class="bg-white rounded-xl shadow-sm p-4 h-full flex flex-col">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-lg font-bold">消息与权限管理</h3>
          <span id="hostStatus" class="text-xs px-2 py-1 rounded-full bg-gray-100">未连接</span>
        </div>

        <!-- 客人权限管理区 -->
        <div class="mb-4 border-b pb-2">
          <h4 class="font-semibold mb-2">客人权限管理</h4>
          
          <!-- 待验证客人 -->
          <div class="mb-3">
            <h5 class="text-sm font-medium text-orange-600">待验证客人</h5>
            <div id="hostPendingGuests" class="bg-orange-50 p-2 rounded-lg min-h-[40px]">
              <p class="text-xs text-gray-500">暂无待验证客人</p>
            </div>
          </div>
          
          <!-- 已允许客人 -->
          <div>
            <h5 class="text-sm font-medium text-green-600">已允许客人（可移除）</h5>
            <div id="hostAllowedGuests" class="bg-green-50 p-2 rounded-lg min-h-[40px]">
              <p class="text-xs text-gray-500">暂无已允许客人</p>
            </div>
          </div>
        </div>

        <!-- 离线消息区 -->
        <div class="mb-4">
          <h4 class="font-semibold mb-2">离线消息</h4>
          <div id="hostOfflineMessages" class="bg-gray-50 p-2 rounded-lg">
            <p id="hostNoOffline" class="text-gray-500">暂无离线消息</p>
            <div id="hostOfflineList" class="hidden"></div>
          </div>
        </div>

        <!-- 在线消息区 -->
        <div class="mb-4">
          <h4 class="font-semibold mb-2">在线消息</h4>
          <div id="hostOnlineMessages" class="flex-1 overflow-y-auto p-2"></div>
        </div>

        <!-- 回复区 -->
        <div class="flex">
          <input type="text" id="hostReplyInput" placeholder="回复消息..." 
            class="flex-1 px-4 py-2 border border-gray-300 rounded-l-lg focus:outline-none focus:ring-2 focus:ring-green-500">
          <button id="hostReplyBtn" class="bg-green-600 text-white px-4 py-2 rounded-r-lg hover:bg-green-700 transition-colors">
            回复
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // 配置参数（部署时替换为实际值）
    const HOST_ID = "i_1721000000000xyz"; // 主人固定ID（从主人界面生成后填入）
    const SIGNAL_WS = "wss://msg-signal.yourname.workers.dev"; // 信令服务器地址

    // 全局变量
    let ws = null;
    let guestId = null;
    let isGuestVerified = false;

    // 初始化客人ID（本地存储）
    function initGuest() {
      const GUEST_STORAGE = "msg_guest_data";
      const stored = localStorage.getItem(GUEST_STORAGE);
      if (stored) {
        const data = JSON.parse(stored);
        guestId = data.id;
        isGuestVerified = data.isVerified || false;
        document.getElementById("guestNickname").value = data.nickname || "";
      } else {
        guestId = "guest_" + Date.now() + Math.random().toString(36).slice(2, 8);
      }
    }
    initGuest();

    // 切换到主人管理界面
    document.getElementById("adminBtn").addEventListener("click", () => {
      document.getElementById("guestPanel").classList.remove("active");
      document.getElementById("hostPanel").classList.add("active");
    });

    // 主人返回客人界面
    document.getElementById("hostBackBtn").addEventListener("click", () => {
      if (ws) {
        ws.close();
        ws = null;
      }
      document.getElementById("hostPanel").classList.remove("active");
      document.getElementById("guestPanel").classList.add("active");
    });

    // 客人进入聊天
    document.getElementById("guestEnterBtn").addEventListener("click", () => {
      const nickname = document.getElementById("guestNickname").value.trim();
      if (!nickname) return alert("请输入昵称");

      // 保存客人信息
      localStorage.setItem("msg_guest_data", JSON.stringify({
        id: guestId,
        nickname: nickname,
        isVerified: isGuestVerified
      }));

      document.getElementById("guestLogin").classList.add("hidden");
      document.getElementById("guestChat").classList.remove("hidden");
      connectGuest(nickname);
    });

    // 客人连接信令服务器
    function connectGuest(nickname) {
      ws = new WebSocket(`${SIGNAL_WS}?id=${guestId}&role=guest`);

      ws.onopen = () => {
        document.getElementById("guestStatus").textContent = "在线";
        document.getElementById("guestStatus").className = "text-xs px-2 py-1 rounded-full bg-green-100 text-green-800";
        if (!isGuestVerified) {
          document.getElementById("guestVerifyTip").classList.remove("hidden");
        }
      };

      ws.onmessage = (event) => {
        const data = JSON.parse(event.data);
        if (data.type === "verifyPass") {
          // 验证通过
          isGuestVerified = true;
          document.getElementById("guestVerifyTip").classList.add("hidden");
          localStorage.setItem("msg_guest_data", JSON.stringify({
            id: guestId,
            nickname: nickname,
            isVerified: true
          }));
          alert("主人已通过你的验证，可正常发送消息");
        } else if (data.type === "verifyReject") {
          // 验证被拒绝
          document.getElementById("guestVerifyTip").textContent = "你的消息已被主人拒绝";
          document.getElementById("guestVerifyTip").className = "p-2 bg-red-50 text-red-700 rounded-lg mb-2 text-sm";
        } else if (data.type === "message" && data.from === "host") {
          // 接收主人消息
          addGuestMessage("主人", data.content, data.time);
        }
      };

      ws.onclose = () => {
        document.getElementById("guestStatus").textContent = "离线";
        document.getElementById("guestStatus").className = "text-xs px-2 py-1 rounded-full bg-gray-100 text-gray-800";
      };
    }

    // 客人发送消息
    document.getElementById("guestSendBtn").addEventListener("click", () => {
      if (!ws) return;
      const content = document.getElementById("guestMsgInput").value.trim();
      if (!content) return;

      const nickname = document.getElementById("guestNickname").value.trim();
      const msgType = isGuestVerified ? "message" : "verifyRequest";

      ws.send(JSON.stringify({
        type: msgType,
        to: HOST_ID,
        from: nickname,
        guestId: guestId,
        content: content,
        time: new Date().toLocaleTimeString()
      }));

      addGuestMessage("我", content, new Date().toLocaleTimeString());
      document.getElementById("guestMsgInput").value = "";
    });

    // 渲染客人消息
    function addGuestMessage(from, content, time) {
      const msgDiv = document.createElement("div");
      const isSelf = from === "我";
      msgDiv.className = `mb-2 p-2 rounded-lg ${isSelf ? "bg-blue-50" : "bg-gray-50"}`;
      msgDiv.innerHTML = `
        <div class="text-xs text-gray-500">${from} ${time}</div>
        <div>${content}</div>
      `;
      document.getElementById("guestMessages").appendChild(msgDiv);
      document.getElementById("guestMessages").scrollTop = document.getElementById("guestMessages").scrollHeight;
    }

    // 主人生成ID
    document.getElementById("hostGenIdBtn").addEventListener("click", () => {
      const newId = "i_" + Date.now() + Math.random().toString(36).slice(2, 8);
      document.getElementById("hostId").value = newId;
      alert(`主人ID已生成：${newId}\n请替换代码中的HOST_ID`);
    });

    // 主人登录
    document.getElementById("hostLoginBtn").addEventListener("click", () => {
      const hostId = document.getElementById("hostId").value.trim();
      const pwd = document.getElementById("hostPassword").value.trim();

      if (!hostId) return alert("请生成或输入主人ID");
      if (pwd.length < 6) return alert("密码至少6位");

      localStorage.setItem("msg_host_id", JSON.stringify({ id: hostId }));
      document.getElementById("hostLogin").classList.add("hidden");
      document.getElementById("hostManage").classList.remove("hidden");
      connectHost(hostId, pwd);
    });

    // 主人连接服务器
    function connectHost(hostId, pwd) {
      ws = new WebSocket(`${SIGNAL_WS}?id=${hostId}&role=host&pwd=${pwd}`);

      ws.onopen = () => {
        document.getElementById("hostStatus").textContent = "在线";
        document.getElementById("hostStatus").className = "text-xs px-2 py-1 rounded-full bg-green-100 text-green-800";
        // 拉取离线消息和权限列表
        ws.send(JSON.stringify({ type: "fetchOffline" }));
        ws.send(JSON.stringify({ type: "fetchPermissions" }));
      };

      ws.onmessage = (event) => {
        const data = JSON.parse(event.data);
        if (data.type === "message") {
          addHostMessage(data.from, data.content, data.time);
        } else if (data.type === "offlineMessages") {
          renderHostOffline(data.messages);
        } else if (data.type === "permissionsList") {
          renderHostPermissions(data.allowed, data.pending);
        }
      };

      ws.onclose = () => {
        document.getElementById("hostStatus").textContent = "离线";
        document.getElementById("hostStatus").className = "text-xs px-2 py-1 rounded-full bg-gray-100 text-gray-800";
      };
    }

    // 渲染主人离线消息
    function renderHostOffline(messages) {
      const listEl = document.getElementById("hostOfflineList");
      const noEl = document.getElementById("hostNoOffline");

      if (messages.length === 0) {
        noEl.classList.remove("hidden");
        listEl.classList.add("hidden");
        return;
      }

      noEl.classList.add("hidden");
      listEl.classList.remove("hidden");
      listEl.innerHTML = "";

      messages.forEach(msg => {
        const div = document.createElement("div");
        div.className = "mb-2 p-2 bg-white rounded-lg border border-gray-100";
        div.innerHTML = `
          <div class="text-xs text-gray-500">${msg.from} ${msg.time}</div>
          <div>${msg.content}</div>
          <button class="mt-1 text-xs text-green-600 hover:underline" onclick="this.parentElement.remove()">
            标记已读
          </button>
        `;
        listEl.appendChild(div);
      });
    }

    // 渲染主人权限列表
    function renderHostPermissions(allowed, pending) {
      const pendingEl = document.getElementById("hostPendingGuests");
      const allowedEl = document.getElementById("hostAllowedGuests");

      // 待验证客人
      pendingEl.innerHTML = pending.length === 0
        ? '<p class="text-xs text-gray-500">暂无待验证客人</p>'
        : pending.map(guest => `
          <div class="flex items-center justify-between mb-1">
            <span class="text-sm">${guest.nickname}（${guest.id}）</span>
            <div>
              <button onclick="hostAllow('${guest.id}', '${guest.nickname}')" class="text-xs text-green-600 hover:underline">允许</button>
              <button onclick="hostReject('${guest.id}')" class="text-xs text-red-600 hover:underline ml-2">禁止</button>
            </div>
          </div>
        `).join("");

      // 已允许客人
      allowedEl.innerHTML = allowed.length === 0
        ? '<p class="text-xs text-gray-500">暂无已允许客人</p>'
        : allowed.map(guest => `
          <div class="flex items-center justify-between mb-1">
            <span class="text-sm">${guest.nickname}（${guest.id}）</span>
            <button onclick="hostRemove('${guest.id}')" class="text-xs text-red-600 hover:underline">移除</button>
          </div>
        `).join("");
    }

    // 主人添加在线消息
    function addHostMessage(from, content, time) {
      const msgDiv = document.createElement("div");
      const isSelf = from === "我";
      msgDiv.className = `mb-2 p-2 rounded-lg ${isSelf ? "bg-green-50" : "bg-gray-50"}`;
      msgDiv.innerHTML = `
        <div class="text-xs text-gray-500">${from} ${time}</div>
        <div>${content}</div>
      `;
      document.getElementById("hostOnlineMessages").appendChild(msgDiv);
      document.getElementById("hostOnlineMessages").scrollTop = document.getElementById("hostOnlineMessages").scrollHeight;
    }

    // 主人回复消息
    document.getElementById("hostReplyBtn").addEventListener("click", () => {
      if (!ws) return;
      const content = document.getElementById("hostReplyInput").value.trim();
      if (!content) return;

      const targetId = prompt("输入客人ID（留空则广播）：");
      ws.send(JSON.stringify({
        type: "message",
        to: targetId || "",
        from: "host",
        content: content,
        time: new Date().toLocaleTimeString()
      }));

      addHostMessage("我", content, new Date().toLocaleTimeString());
      document.getElementById("hostReplyInput").value = "";
    });

    // 主人权限操作（全局函数）
    window.hostAllow = (guestId, nickname) => {
      ws.send(JSON.stringify({ type: "allowGuest", guestId, nickname }));
    };
    window.hostReject = (guestId) => {
      ws.send(JSON.stringify({ type: "rejectGuest", guestId }));
    };
    window.hostRemove = (guestId) => {
      ws.send(JSON.stringify({ type: "removeGuest", guestId }));
    };
  </script>
</body>
</html>


